name: Deploy Code Changes (Restart Container)

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'
      - 'style.css'
      - 'mediaquaries.css'
      - 'script.js'
      - 'assets/**'
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Update Code and Restart Container
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/deploy_key << 'EOF'
          ${{ secrets.EC2_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/deploy_key

      - name: Update Code and Restart Container
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOSSH'
            set -x
            
            echo "=== Updating Portfolio Code ==="
            cd /home/ec2-user/My-Portfolio
            
            # Pull latest code
            echo "Pulling latest code..."
            git pull origin main
            
            # Copy updated files into running container
            echo "Updating files in container..."
            sudo docker cp . my-portfolio-app:/usr/share/nginx/html/
            
            # Verify
            echo "✅ Code updated successfully!"
          
          EOSSH

      - name: Verify Deployment
        run: |
          sleep 3
          echo "Checking if website is updated..."
          curl -f http://${{ secrets.EC2_HOST }} > /dev/null && echo "✅ Website is online!" || echo "⚠️ Website check failed"

      - name: Deployment Success
        run: |
          echo "✅ Code deployment complete!"
          echo "Your website has been updated: http://${{ secrets.EC2_HOST }}"
