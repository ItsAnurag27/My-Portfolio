name: Deploy Code Changes (Restart Container)

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'
      - 'style.css'
      - 'mediaquaries.css'
      - 'script.js'
      - 'assets/**'
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Update Code and Restart Container
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Update Code and Restart Container
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -x
            
            echo "=== Updating Portfolio Code ==="
            cd /home/ec2-user/My-Portfolio
            
            # Pull latest code
            echo "Pulling latest code..."
            git pull origin main
            
            # Copy updated files into running container
            echo "Updating files in container..."
            sudo docker cp . my-portfolio-app:/usr/share/nginx/html/
            
            # Verify
            echo "✅ Code updated successfully!"

      - name: Verify Deployment
        run: |
          sleep 3
          echo "Checking if website is updated..."
          curl -f http://${{ secrets.EC2_HOST }} > /dev/null && echo "✅ Website is online!" || echo "⚠️ Website check failed"

      - name: Deployment Success
        run: |
          echo "✅ Code deployment complete!"
          echo "Your website has been updated: http://${{ secrets.EC2_HOST }}"
